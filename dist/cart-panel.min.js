!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).CartDialog={})}(this,function(t){"use strict";class CartItem extends HTMLElement{static#t=null;static#e=null;#r="ready";#n=!1;#s={};#a=null;static setTemplate(t){if("function"!=typeof t)throw new Error("Template must be a function");CartItem.#t=t}static setProcessingTemplate(t){if("function"!=typeof t)throw new Error("Processing template must be a function");CartItem.#e=t}static createAnimated(t){return new CartItem(t,{animate:!0})}static get observedAttributes(){return["state","key"]}attributeChangedCallback(t,e,r){e!==r&&"state"===t&&(this.#r=r||"ready")}constructor(t=null,e={}){super(),this.#a=t;const r=e.animate||this.hasAttribute("animate-in");this.#r=t&&r?"appearing":this.getAttribute("state")||"ready",this.#s={click:this.#i.bind(this),change:this.#o.bind(this),transitionEnd:this.#c.bind(this)}}connectedCallback(){this.#a&&this.#l(),this.content=this.querySelector("cart-item-content"),this.processing=this.querySelector("cart-item-processing"),this.#d(),"appearing"===this.#r&&(this.setAttribute("state","appearing"),requestAnimationFrame(()=>{const t=this.scrollHeight;this.style.height=`${t}px`,requestAnimationFrame(()=>{this.setState("ready")})}))}disconnectedCallback(){this.#h()}#d(){this.addEventListener("click",this.#s.click),this.addEventListener("change",this.#s.change),this.addEventListener("transitionend",this.#s.transitionEnd)}#h(){this.removeEventListener("click",this.#s.click),this.removeEventListener("change",this.#s.change),this.removeEventListener("transitionend",this.#s.transitionEnd)}get state(){return this.#r}get cartKey(){return this.getAttribute("key")}#i(t){t.target.closest("[data-action-remove-item]")&&(t.preventDefault(),this.#m())}#o(t){const e=t.target.closest("[data-cart-quantity]");e&&this.#u(e.value)}#c(t){"height"===t.propertyName&&this.#n?this.remove():"height"===t.propertyName&&"ready"===this.#r&&(this.style.height="")}#m(){this.dispatchEvent(new CustomEvent("cart-item:remove",{bubbles:!0,detail:{cartKey:this.cartKey,element:this}}))}#u(t){this.dispatchEvent(new CustomEvent("cart-item:quantity-change",{bubbles:!0,detail:{cartKey:this.cartKey,quantity:parseInt(t),element:this}}))}#l(){if(!this.#a||!CartItem.#t)return;const t=this.#a.key||this.#a.id;t&&this.setAttribute("key",t);const e=CartItem.#t(this.#a),r=CartItem.#e?CartItem.#e():'<div class="cart-item-loader"></div>';this.innerHTML=`\n      <cart-item-content>\n        ${e}\n      </cart-item-content>\n      <cart-item-processing>\n        ${r}\n      </cart-item-processing>\n    `}setData(t){this.#a=t,this.#l(),this.content=this.querySelector("cart-item-content"),this.processing=this.querySelector("cart-item-processing")}get itemData(){return this.#a}setState(t){["ready","processing","destroying","appearing"].includes(t)&&this.setAttribute("state",t)}destroyYourself(){if(this.#n)return;this.#n=!0;const t=this.offsetHeight;this.setState("destroying"),requestAnimationFrame(()=>{this.style.height=`${t}px`,this.offsetHeight;const e=getComputedStyle(this),r=e.getPropertyValue("--cart-item-destroying-duration")?.trim()||"400ms";this.style.transition=`height ${r} ease`,this.style.height="0px"})}}class CartItemContent extends HTMLElement{constructor(){super()}}class CartItemProcessing extends HTMLElement{constructor(){super()}}customElements.get("cart-item")||customElements.define("cart-item",CartItem),customElements.get("cart-item-content")||customElements.define("cart-item-content",CartItemContent),customElements.get("cart-item-processing")||customElements.define("cart-item-processing",CartItemProcessing);const e=t=>Array.from(t.querySelectorAll('summary, a[href], button:not(:disabled), [tabindex]:not([tabindex^="-"]):not(focus-trap-start):not(focus-trap-end), [draggable], area, input:not([type=hidden]):not(:disabled), select:not(:disabled), textarea:not(:disabled), object, iframe'));class FocusTrap extends HTMLElement{static styleInjected=!1;constructor(){super(),this.trapStart=null,this.trapEnd=null,FocusTrap.styleInjected||(this.injectStyles(),FocusTrap.styleInjected=!0)}injectStyles(){const t=document.createElement("style");t.textContent="\n      focus-trap-start,\n      focus-trap-end {\n        position: absolute;\n        width: 1px;\n        height: 1px;\n        margin: -1px;\n        padding: 0;\n        border: 0;\n        clip: rect(0, 0, 0, 0);\n        overflow: hidden;\n        white-space: nowrap;\n      }\n    ",document.head.appendChild(t)}connectedCallback(){this.setupTrap(),this.addEventListener("keydown",this.handleKeyDown)}disconnectedCallback(){this.removeEventListener("keydown",this.handleKeyDown)}setupTrap(){0!==e(this).length&&(this.trapStart=document.createElement("focus-trap-start"),this.trapEnd=document.createElement("focus-trap-end"),this.prepend(this.trapStart),this.append(this.trapEnd))}handleKeyDown=t=>{"Escape"===t.key&&(t.preventDefault(),this.exitTrap())};exitTrap(){const t=this.closest('[aria-hidden="false"]');if(!t)return;t.setAttribute("aria-hidden","true");const e=document.querySelector(`[aria-expanded="true"][aria-controls="${t.id}"]`);e&&(e.setAttribute("aria-expanded","false"),e.focus())}}class FocusTrapStart extends HTMLElement{connectedCallback(){this.setAttribute("tabindex","0"),this.addEventListener("focus",this.handleFocus)}disconnectedCallback(){this.removeEventListener("focus",this.handleFocus)}handleFocus=t=>{const r=this.closest("focus-trap"),n=e(r);if(0===n.length)return;const s=n[0],a=n[n.length-1];t.relatedTarget===s?a.focus():s.focus()}}class FocusTrapEnd extends HTMLElement{connectedCallback(){this.setAttribute("tabindex","0"),this.addEventListener("focus",this.handleFocus)}disconnectedCallback(){this.removeEventListener("focus",this.handleFocus)}handleFocus=()=>{this.closest("focus-trap").querySelector("focus-trap-start").focus()}}customElements.get("focus-trap")||customElements.define("focus-trap",FocusTrap),customElements.get("focus-trap-start")||customElements.define("focus-trap-start",FocusTrapStart),customElements.get("focus-trap-end")||customElements.define("focus-trap-end",FocusTrapEnd);class EventEmitter{#p;constructor(){this.#p=new Map}on(t,e){if("function"!=typeof e)throw new TypeError("Listener must be a function");const r=this.#p.get(t)||[];return r.includes(e)||r.push(e),this.#p.set(t,r),this}off(t,e){const r=this.#p.get(t);if(!r)return this;const n=r.indexOf(e);return-1!==n&&(r.splice(n,1),0===r.length?this.#p.delete(t):this.#p.set(t,r)),this}emit(t,...e){const r=this.#p.get(t);if(!r||0===r.length)return!1;for(let n=0,s=r.length;n<s;++n)try{r[n].apply(this,e)}catch(e){console.error(`Error in listener for event '${t}':`,e)}return!0}removeAllListeners(t){return t?this.#p.delete(t):this.#p.clear(),this}}class CartDialog extends HTMLElement{#c;#g=0;#y=null;#f;#E=!0;disconnectedCallback(){const t=this;t.contentPanel&&t.contentPanel.removeEventListener("transitionend",t.#c),document.body.classList.remove("overflow-hidden"),this.#C(),this.#h()}#v(){this.#g=window.pageYOffset,document.body.classList.add("overflow-hidden"),document.body.style.top=`-${this.#g}px`}#C(){document.body.classList.remove("overflow-hidden"),document.body.style.removeProperty("top"),window.scrollTo(0,this.#g)}constructor(){super();const t=this;t.id=t.getAttribute("id"),t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.setAttribute("aria-hidden","true"),t.triggerEl=null,t.#f=new EventEmitter,t.#c=e=>{"opacity"===e.propertyName&&"true"===t.getAttribute("aria-hidden")&&(t.contentPanel.classList.add("hidden"),t.#b("cart-dialog:afterHide",{triggerElement:t.triggerEl}))}}connectedCallback(){const t=this;if(t.contentPanel=t.querySelector("cart-panel"),t.contentPanel){if(t.focusTrap=document.createElement("focus-trap"),!t.getAttribute("aria-labelledby")){const e=t.querySelector("h1, h2, h3");e&&!e.id&&(e.id=`${t.id}-title`),e?.id&&t.setAttribute("aria-labelledby",e.id)}t.contentPanel.parentNode.insertBefore(t.focusTrap,t.contentPanel),t.focusTrap.appendChild(t.contentPanel),t.focusTrap.setupTrap(),t.querySelector("cart-overlay")||t.prepend(document.createElement("cart-overlay")),t.#d(),t.#T()}else console.error("cart-panel element not found inside cart-dialog")}on(t,e){return this.#f.on(t,e),this}off(t,e){return this.#f.off(t,e),this}#b(t,e=null){this.#f.emit(t,e)}#d(){const t=this;document.addEventListener("click",e=>{const r=e.target.closest(`[aria-controls="${t.id}"]`);r&&("true"===r.getAttribute("data-prevent-default")&&e.preventDefault(),t.show(r))}),t.addEventListener("click",e=>{e.target.closest("[data-action-hide-cart]")&&t.hide()}),t.addEventListener("cart-item:remove",e=>{t.#S(e)}),t.addEventListener("cart-item:quantity-change",e=>{t.#I(e)}),t.contentPanel.addEventListener("transitionend",t.#c)}#h(){const t=this;t.contentPanel&&t.contentPanel.removeEventListener("transitionend",t.#c)}#T(){this.addEventListener("keydown",t=>{"Escape"===t.key&&this.hide()})}#S(t){const{cartKey:e,element:r}=t.detail;r.setState("processing"),this.updateCartItem(e,0).then(t=>{t&&!t.error?(this.#y=t,this.#L(t),this.#k(t),this.#b("cart-dialog:updated",{cart:t}),this.#b("cart-dialog:data-changed",t)):(r.setState("ready"),console.error("Failed to remove cart item:",e))}).catch(t=>{r.setState("ready"),console.error("Error removing cart item:",t)})}#I(t){const{cartKey:e,quantity:r,element:n}=t.detail;n.setState("processing"),this.updateCartItem(e,r).then(t=>{t&&!t.error?(this.#y=t,this.#L(t),this.#k(t),n.setState("ready"),this.#b("cart-dialog:updated",{cart:t}),this.#b("cart-dialog:data-changed",t)):(n.setState("ready"),console.error("Failed to update cart item quantity:",e,r))}).catch(t=>{n.setState("ready"),console.error("Error updating cart item quantity:",t)})}#k(t=null){const e=t||this.#y;if(!e)return;const r=this.querySelector("[data-cart-has-items]"),n=this.querySelector("[data-cart-is-empty]"),s=this.querySelector("[data-content-cart-items]");r&&n&&s?e.item_count>0?(r.style.display="block",n.style.display="none"):(r.style.display="none",n.style.display="block"):console.warn("Cart sections not found. Expected [data-cart-has-items], [data-cart-is-empty], and [data-content-cart-items]")}getCart(){return fetch("/cart.json",{crossDomain:!0,credentials:"same-origin"}).then(t=>{if(!t.ok)throw Error(t.statusText);return t.json()}).catch(t=>(console.error("Error fetching cart:",t),{error:!0,message:t.message}))}updateCartItem(t,e){return fetch("/cart/change.json",{crossDomain:!0,method:"POST",credentials:"same-origin",body:JSON.stringify({id:t,quantity:e}),headers:{"Content-Type":"application/json"}}).then(t=>{if(!t.ok)throw Error(t.statusText);return t.json()}).catch(t=>(console.error("Error updating cart item:",t),{error:!0,message:t.message}))}refreshCart(){return console.log("Refreshing cart..."),this.getCart().then(t=>(console.log("Cart data received:",t),t&&!t.error?(this.#y=t,this.#L(t),this.#k(t),this.#b("cart-dialog:refreshed",{cart:t}),this.#b("cart-dialog:data-changed",t)):console.warn("Cart data has error or is null:",t),t))}#A(t,e){const r=Array.from(t.querySelectorAll("cart-item")).filter(t=>!e.has(t.getAttribute("key")));console.log(`Removing ${r.length} items:`,r.map(t=>t.getAttribute("key"))),r.forEach(t=>{t.destroyYourself()})}#w(t,e,r){console.log(`Adding ${e.length} items:`,e.map(t=>t.key||t.id)),setTimeout(()=>{e.forEach(e=>{const n=CartItem.createAnimated(e),s=r.indexOf(e.key||e.id);if(0===s)t.insertBefore(n,t.firstChild);else{let e=null;for(let n=s-1;n>=0;n--){const s=r[n],a=t.querySelector(`cart-item[key="${s}"]`);if(a){e=a;break}}e?e.insertAdjacentElement("afterend",n):t.appendChild(n)}})},100)}#L(t){const e=this.querySelector("[data-content-cart-items]");if(!e||!t||!t.items)return void console.warn("Cannot render cart items:",{itemsContainer:!!e,cartData:!!t,items:t?.items?.length});if(this.#E)return console.log("Initial cart render:",t.items.length,"items"),e.innerHTML="",t.items.forEach(t=>{const r=new CartItem(t);e.appendChild(r)}),this.#E=!1,void console.log("Initial render complete, container children:",e.children.length);console.log("Smart rendering cart items:",t.items.length,"items");const r=Array.from(e.querySelectorAll("cart-item")),n=new Set(r.map(t=>t.getAttribute("key"))),s=t.items.map(t=>t.key||t.id),a=new Set(s);this.#A(e,a);const i=t.items.filter(t=>!n.has(t.key||t.id));this.#w(e,i,s),console.log("Smart rendering complete, container children:",e.children.length)}setCartItemTemplate(t){CartItem.setTemplate(t)}setCartItemProcessingTemplate(t){CartItem.setProcessingTemplate(t)}show(t=null){const e=this;e.triggerEl=t||!1,e.contentPanel.classList.remove("hidden"),requestAnimationFrame(()=>{e.setAttribute("aria-hidden","false"),e.triggerEl&&e.triggerEl.setAttribute("aria-expanded","true"),e.#v();const t=e.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');t&&requestAnimationFrame(()=>{t.focus()}),e.refreshCart(),e.#b("cart-dialog:show",{triggerElement:e.triggerEl})})}hide(){const t=this;t.#C(),t.triggerEl&&(t.triggerEl.focus(),t.triggerEl.setAttribute("aria-expanded","false")),t.setAttribute("aria-hidden","true"),t.#b("cart-dialog:hide",{triggerElement:t.triggerEl})}}class CartOverlay extends HTMLElement{constructor(){super(),this.setAttribute("tabindex","-1"),this.setAttribute("aria-hidden","true"),this.cartDialog=this.closest("cart-dialog"),this.#d()}#d(){this.addEventListener("click",()=>{this.cartDialog.hide()})}}class CartPanel extends HTMLElement{constructor(){super(),this.setAttribute("role","document")}}customElements.get("cart-dialog")||customElements.define("cart-dialog",CartDialog),customElements.get("cart-overlay")||customElements.define("cart-overlay",CartOverlay),customElements.get("cart-panel")||customElements.define("cart-panel",CartPanel),"undefined"!=typeof window&&(window.CartItem=CartItem),t.CartDialog=CartDialog,t.CartItem=CartItem,t.CartOverlay=CartOverlay,t.CartPanel=CartPanel,t.default=CartDialog,Object.defineProperty(t,"__esModule",{value:!0})});
