!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).CartDialog={})}(this,function(t){"use strict";class QuantityModifier extends HTMLElement{static#t=!1;constructor(){super(),this.handleDecrement=this.handleDecrement.bind(this),this.handleIncrement=this.handleIncrement.bind(this),this.handleInputChange=this.handleInputChange.bind(this),QuantityModifier.#e()}static#e(){if(QuantityModifier.#t)return;const t=document.createElement("style");t.textContent='\n      /* Hide number input spin buttons for quantity-modifier */\n      quantity-modifier input::-webkit-outer-spin-button,\n      quantity-modifier input::-webkit-inner-spin-button {\n        -webkit-appearance: none;\n        margin: 0;\n      }\n      \n      quantity-modifier input[type="number"] {\n        -moz-appearance: textfield;\n      }\n    ',document.head.appendChild(t),QuantityModifier.#t=!0}static get observedAttributes(){return["min","max","value"]}connectedCallback(){this.render(),this.attachEventListeners()}disconnectedCallback(){this.removeEventListeners()}attributeChangedCallback(t,e,n){e!==n&&this.updateInput()}get min(){return parseInt(this.getAttribute("min"))||1}get max(){return parseInt(this.getAttribute("max"))||99}get value(){return parseInt(this.getAttribute("value"))||1}set value(t){this.setAttribute("value",t)}render(){const t=this.min,e=this.max,n=this.value,r=this.querySelector("[data-action-decrement]"),i=this.querySelector("[data-action-increment]"),a=this.querySelector("[data-quantity-modifier-field]");r&&i&&a?(a.value=n,a.min=t,a.max=e,a.type="number"):this.innerHTML=`\n        <button data-action-decrement type="button">\n          <svg class="svg-decrement" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">\n            <title>decrement</title>\n            <path fill="currentColor" d="M368 224H16c-8.84 0-16 7.16-16 16v32c0 8.84 7.16 16 16 16h352c8.84 0 16-7.16 16-16v-32c0-8.84-7.16-16-16-16z"></path>\n          </svg>\n        </button>\n        <input \n          type="number" \n          inputmode="numeric" \n          pattern="[0-9]*" \n          data-quantity-modifier-field \n          value="${n}" min="${t}" max="${e}">\n        <button data-action-increment type="button">\n          <svg class="svg-increment" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">\n            <title>increment</title>\n            <path fill="currentColor" d="M368 224H224V80c0-8.84-7.16-16-16-16h-32c-8.84 0-16 7.16-16 16v144H16c-8.84 0-16 7.16-16 16v32c0 8.84 7.16 16 16 16h144v144c0 8.84 7.16 16 16 16h32c8.84 0 16-7.16 16-16V288h144c8.84 0 16-7.16 16-16v-32c0-8.84-7.16-16-16-16z"></path>\n          </svg>\n        </button>\n      `}attachEventListeners(){const t=this.querySelector("[data-action-decrement]"),e=this.querySelector("[data-action-increment]"),n=this.querySelector("[data-quantity-modifier-field]");t&&t.addEventListener("click",this.handleDecrement),e&&e.addEventListener("click",this.handleIncrement),n&&n.addEventListener("input",this.handleInputChange)}removeEventListeners(){const t=this.querySelector("[data-action-decrement]"),e=this.querySelector("[data-action-increment]"),n=this.querySelector("[data-quantity-modifier-field]");t&&t.removeEventListener("click",this.handleDecrement),e&&e.removeEventListener("click",this.handleIncrement),n&&n.removeEventListener("input",this.handleInputChange)}handleDecrement(){const t=this.value,e=Math.max(t-1,this.min);this.updateValue(e)}handleIncrement(){const t=this.value,e=Math.min(t+1,this.max);this.updateValue(e)}handleInputChange(t){const e=parseInt(t.target.value);if(!isNaN(e)){const t=Math.max(this.min,Math.min(e,this.max));this.updateValue(t)}}updateValue(t){t!==this.value&&(this.value=t,this.updateInput(),this.dispatchChangeEvent(t))}updateInput(){const t=this.querySelector("[data-quantity-modifier-field]");t&&(t.value=this.value,t.min=this.min,t.max=this.max)}dispatchChangeEvent(t){this.dispatchEvent(new CustomEvent("quantity-modifier:change",{detail:{value:t},bubbles:!0}))}}customElements.define("quantity-modifier",QuantityModifier);class CartItem extends HTMLElement{static#n=new Map;static#r=null;#i="ready";#a=!1;#s=!1;#o={};#c=null;#l=null;static setTemplate(t,e){if("string"!=typeof t)throw new Error("Template name must be a string");if("function"!=typeof e)throw new Error("Template must be a function");CartItem.#n.set(t,e)}static setProcessingTemplate(t){if("function"!=typeof t)throw new Error("Processing template must be a function");CartItem.#r=t}static createAnimated(t,e){return new CartItem(t,e,{animate:!0})}static get observedAttributes(){return["state","key"]}attributeChangedCallback(t,e,n){e!==n&&"state"===t&&(this.#i=n||"ready")}constructor(t=null,e=null,n={}){super(),this.#c=t,this.#l=e;const r=n.animate||this.hasAttribute("animate-in");this.#i=t&&r?"appearing":this.getAttribute("state")||"ready",this.#o={click:this.#d.bind(this),change:this.#h.bind(this),transitionEnd:this.#u.bind(this)}}connectedCallback(){this.#c&&this.#m(),this.content=this.querySelector("cart-item-content"),this.processing=this.querySelector("cart-item-processing"),this.#p(),this.#g(),"appearing"===this.#i&&(this.setAttribute("state","appearing"),this.#s=!0,requestAnimationFrame(()=>{const t=this.scrollHeight;this.style.height=`${t}px`,requestAnimationFrame(()=>{this.setState("ready")})}))}disconnectedCallback(){this.#f()}#g(){this.addEventListener("click",this.#o.click),this.addEventListener("change",this.#o.change),this.addEventListener("quantity-modifier:change",this.#o.change),this.addEventListener("transitionend",this.#o.transitionEnd)}#f(){this.removeEventListener("click",this.#o.click),this.removeEventListener("change",this.#o.change),this.removeEventListener("quantity-modifier:change",this.#o.change),this.removeEventListener("transitionend",this.#o.transitionEnd)}get state(){return this.#i}get cartKey(){return this.getAttribute("key")}#d(t){t.target.closest("[data-action-remove-item]")&&(t.preventDefault(),this.#y())}#h(t){if("quantity-modifier:change"===t.type)return void this.#v(t.detail.value);const e=t.target.closest("[data-cart-quantity]");e&&this.#v(e.value)}#u(t){"height"===t.propertyName&&this.#a?this.remove():"height"===t.propertyName&&this.#s&&(this.style.height="",this.#s=!1)}#y(){this.dispatchEvent(new CustomEvent("cart-item:remove",{bubbles:!0,detail:{cartKey:this.cartKey,element:this}}))}#v(t){this.dispatchEvent(new CustomEvent("cart-item:quantity-change",{bubbles:!0,detail:{cartKey:this.cartKey,quantity:parseInt(t),element:this}}))}#m(){if(!this.#c||0===CartItem.#n.size)return void console.log("no item data or no template",this.#c,CartItem.#n);const t=this.#c.key||this.#c.id;t&&this.setAttribute("key",t);const e=this.#c.properties?._cart_template||"default",n=CartItem.#n.get(e)||CartItem.#n.get("default");if(!n)return void console.warn(`Cart item template '${e}' not found and no default template set`);const r=n(this.#c,this.#l),i=CartItem.#r?CartItem.#r():'<div class="cart-item-loader"></div>';this.innerHTML=`\n      <cart-item-content>\n        ${r}\n      </cart-item-content>\n      <cart-item-processing>\n        ${i}\n      </cart-item-processing>\n    `}setData(t,e=null){this.#c=t,e&&(this.#l=e),this.#m(),this.content=this.querySelector("cart-item-content"),this.processing=this.querySelector("cart-item-processing"),this.#p()}#p(){if(!this.#c)return;const t=this.querySelectorAll("[data-content-line-price]"),e=this.#E(this.#c.line_price||0);t.forEach(t=>{t.textContent=e})}#E(t){return"number"!=typeof t?"$0.00":`$${(t/100).toFixed(2)}`}get itemData(){return this.#c}setState(t){["ready","processing","destroying","appearing"].includes(t)&&this.setAttribute("state",t)}destroyYourself(){if(this.#a)return;this.#a=!0;const t=this.offsetHeight;this.setState("destroying"),requestAnimationFrame(()=>{this.style.height=`${t}px`;const e=getComputedStyle(this),n=e.getPropertyValue("--cart-item-destroying-duration")?.trim()||"400ms";this.style.transition=`height ${n} ease`,this.style.height="0px",setTimeout(()=>{this.remove()},600)})}}class CartItemContent extends HTMLElement{constructor(){super()}}class CartItemProcessing extends HTMLElement{constructor(){super()}}customElements.get("cart-item")||customElements.define("cart-item",CartItem),customElements.get("cart-item-content")||customElements.define("cart-item-content",CartItemContent),customElements.get("cart-item-processing")||customElements.define("cart-item-processing",CartItemProcessing);const e=t=>Array.from(t.querySelectorAll('summary, a[href], button:not(:disabled), [tabindex]:not([tabindex^="-"]):not(focus-trap-start):not(focus-trap-end), [draggable], area, input:not([type=hidden]):not(:disabled), select:not(:disabled), textarea:not(:disabled), object, iframe'));class FocusTrap extends HTMLElement{static styleInjected=!1;constructor(){super(),this.trapStart=null,this.trapEnd=null,FocusTrap.styleInjected||(this.injectStyles(),FocusTrap.styleInjected=!0)}injectStyles(){const t=document.createElement("style");t.textContent="\n      focus-trap-start,\n      focus-trap-end {\n        position: absolute;\n        width: 1px;\n        height: 1px;\n        margin: -1px;\n        padding: 0;\n        border: 0;\n        clip: rect(0, 0, 0, 0);\n        overflow: hidden;\n        white-space: nowrap;\n      }\n    ",document.head.appendChild(t)}connectedCallback(){this.setupTrap(),this.addEventListener("keydown",this.handleKeyDown)}disconnectedCallback(){this.removeEventListener("keydown",this.handleKeyDown)}setupTrap(){0!==e(this).length&&(this.trapStart=document.createElement("focus-trap-start"),this.trapEnd=document.createElement("focus-trap-end"),this.prepend(this.trapStart),this.append(this.trapEnd))}handleKeyDown=t=>{"Escape"===t.key&&(t.preventDefault(),this.exitTrap())};exitTrap(){const t=this.closest('[aria-hidden="false"]');if(!t)return;t.setAttribute("aria-hidden","true");const e=document.querySelector(`[aria-expanded="true"][aria-controls="${t.id}"]`);e&&(e.setAttribute("aria-expanded","false"),e.focus())}}class FocusTrapStart extends HTMLElement{connectedCallback(){this.setAttribute("tabindex","0"),this.addEventListener("focus",this.handleFocus)}disconnectedCallback(){this.removeEventListener("focus",this.handleFocus)}handleFocus=t=>{const n=this.closest("focus-trap"),r=e(n);if(0===r.length)return;const i=r[0],a=r[r.length-1];t.relatedTarget===i?a.focus():i.focus()}}class FocusTrapEnd extends HTMLElement{connectedCallback(){this.setAttribute("tabindex","0"),this.addEventListener("focus",this.handleFocus)}disconnectedCallback(){this.removeEventListener("focus",this.handleFocus)}handleFocus=()=>{this.closest("focus-trap").querySelector("focus-trap-start").focus()}}customElements.get("focus-trap")||customElements.define("focus-trap",FocusTrap),customElements.get("focus-trap-start")||customElements.define("focus-trap-start",FocusTrapStart),customElements.get("focus-trap-end")||customElements.define("focus-trap-end",FocusTrapEnd);class EventEmitter{#C;constructor(){this.#C=new Map}on(t,e){if("function"!=typeof e)throw new TypeError("Listener must be a function");const n=this.#C.get(t)||[];return n.includes(e)||n.push(e),this.#C.set(t,n),this}off(t,e){const n=this.#C.get(t);if(!n)return this;const r=n.indexOf(e);return-1!==r&&(n.splice(r,1),0===n.length?this.#C.delete(t):this.#C.set(t,n)),this}emit(t,...e){const n=this.#C.get(t);if(!n||0===n.length)return!1;for(let r=0,i=n.length;r<i;++r)try{n[r].apply(this,e)}catch(e){console.error(`Error in listener for event '${t}':`,e)}return!0}removeAllListeners(t){return t?this.#C.delete(t):this.#C.clear(),this}}class CartDialog extends HTMLElement{#u;#b=null;#I;#S=!0;disconnectedCallback(){const t=this;t.contentPanel&&t.contentPanel.removeEventListener("transitionend",t.#u),document.body.classList.remove("overflow-hidden"),this.#L(),this.#f()}#x(){document.body.classList.add("overflow-hidden")}#L(){document.body.classList.remove("overflow-hidden")}constructor(){super();const t=this;t.id=t.getAttribute("id"),t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.setAttribute("aria-hidden","true"),t.triggerEl=null,t.#I=new EventEmitter,t.#u=e=>{"opacity"===e.propertyName&&"true"===t.getAttribute("aria-hidden")&&(t.contentPanel.classList.add("hidden"),t.#q("cart-dialog:afterHide",{triggerElement:t.triggerEl}))}}connectedCallback(){const t=this;if(t.contentPanel=t.querySelector("cart-panel"),t.contentPanel){if(t.focusTrap=t.contentPanel.querySelector("focus-trap"),!t.focusTrap){t.focusTrap=document.createElement("focus-trap");Array.from(t.contentPanel.childNodes).forEach(e=>t.focusTrap.appendChild(e)),t.contentPanel.appendChild(t.focusTrap)}if(!t.getAttribute("aria-labelledby")){const e=t.querySelector("h1, h2, h3");e&&!e.id&&(e.id=`${t.id}-title`),e?.id&&t.setAttribute("aria-labelledby",e.id)}t.querySelector("cart-overlay")||t.prepend(document.createElement("cart-overlay")),t.#g(),t.#T(),t.refreshCart()}else console.error("cart-panel element not found inside cart-dialog")}on(t,e){return this.#I.on(t,e),this}off(t,e){return this.#I.off(t,e),this}#q(t,e=null){this.#I.emit(t,e),this.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))}#g(){const t=this;document.addEventListener("click",e=>{const n=e.target.closest(`[aria-controls="${t.id}"]`);n&&("true"===n.getAttribute("data-prevent-default")&&e.preventDefault(),t.show(n))}),t.addEventListener("click",e=>{e.target.closest("[data-action-hide-cart]")&&t.hide()}),t.addEventListener("cart-item:remove",e=>{t.#w(e)}),t.addEventListener("cart-item:quantity-change",e=>{t.#A(e)}),t.contentPanel.addEventListener("transitionend",t.#u)}#f(){const t=this;t.contentPanel&&t.contentPanel.removeEventListener("transitionend",t.#u)}#T(){this.addEventListener("keydown",t=>{"Escape"===t.key&&this.hide()})}#w(t){const{cartKey:e,element:n}=t.detail;n.setState("processing"),this.updateCartItem(e,0).then(t=>{if(t&&!t.error){this.#b=t,this.#k(t),this.#D(t);const e=this.#P(t);this.#q("cart-dialog:updated",{cart:e}),this.#q("cart-dialog:data-changed",e)}else n.setState("ready"),console.error("Failed to remove cart item:",e)}).catch(t=>{n.setState("ready"),console.error("Error removing cart item:",t)})}#A(t){const{cartKey:e,quantity:n,element:r}=t.detail;r.setState("processing"),this.updateCartItem(e,n).then(t=>{if(t&&!t.error){this.#b=t,this.#k(t),this.#D(t),r.setState("ready");const e=this.#P(t);this.#q("cart-dialog:updated",{cart:e}),this.#q("cart-dialog:data-changed",e)}else r.setState("ready"),console.error("Failed to update cart item quantity:",e,n)}).catch(t=>{r.setState("ready"),console.error("Error updating cart item quantity:",t)})}#F(t){if(!t)return;const e=this.#M(t).reduce((t,e)=>t+e.quantity,0);document.querySelectorAll("[data-content-cart-count]").forEach(t=>{t.textContent=e})}#H(t){if(!t)return;const e=this.#M(t).reduce((t,e)=>t+(e.line_price||0),0);document.querySelectorAll("[data-content-cart-subtotal]").forEach(t=>{const n=(e/100).toFixed(2);t.textContent=`$${n}`})}#D(t=null){const e=t||this.#b;if(!e)return;const n=this.querySelector("[data-cart-has-items]"),r=this.querySelector("[data-cart-is-empty]"),i=this.querySelector("[data-content-cart-items]");if(!n||!r||!i)return void console.warn("Cart sections not found. Expected [data-cart-has-items], [data-cart-is-empty], and [data-content-cart-items]");this.#M(e).length>0?(n.style.display="",r.style.display="none"):(n.style.display="none",r.style.display=""),this.#F(e),this.#H(e)}getCart(){return fetch("/cart.json",{crossDomain:!0,credentials:"same-origin"}).then(t=>{if(!t.ok)throw Error(t.statusText);return t.json()}).catch(t=>(console.error("Error fetching cart:",t),{error:!0,message:t.message}))}updateCartItem(t,e){return fetch("/cart/change.json",{crossDomain:!0,method:"POST",credentials:"same-origin",body:JSON.stringify({id:t,quantity:e}),headers:{"Content-Type":"application/json"}}).then(t=>{if(!t.ok)throw Error(t.statusText);return t.json()}).catch(t=>(console.error("Error updating cart item:",t),{error:!0,message:t.message}))}refreshCart(t=null){if(t&&!t.error){this.#b=t,this.#k(t),this.#D(t);const e=this.#P(t);return this.#q("cart-dialog:refreshed",{cart:e}),this.#q("cart-dialog:data-changed",e),Promise.resolve(t)}return this.getCart().then(t=>{if(t&&!t.error){this.#b=t,this.#k(t),this.#D(t);const e=this.#P(t);this.#q("cart-dialog:refreshed",{cart:e}),this.#q("cart-dialog:data-changed",e)}else console.warn("Cart data has error or is null:",t);return t})}#j(t,e){Array.from(t.querySelectorAll("cart-item")).filter(t=>!e.has(t.getAttribute("key"))).forEach(t=>{console.log("destroy yourself",t),t.destroyYourself()})}#$(t,e,n){setTimeout(()=>{e.forEach(e=>{const r=CartItem.createAnimated(e),i=n.indexOf(e.key||e.id);if(0===i)t.insertBefore(r,t.firstChild);else{let e=null;for(let r=i-1;r>=0;r--){const i=n[r],a=t.querySelector(`cart-item[key="${i}"]`);if(a){e=a;break}}e?e.insertAdjacentElement("afterend",r):t.appendChild(r)}})},100)}#M(t){return t&&t.items?t.items.filter(t=>{const e=t.properties?._hide_in_cart;return!e}):[]}#P(t){if(!t)return t;const e=this.#M(t),n=e.reduce((t,e)=>t+e.quantity,0),r=e.reduce((t,e)=>t+(e.line_price||0),0);return{...t,calculated_count:n,calculated_subtotal:r}}#k(t){const e=this.querySelector("[data-content-cart-items]");if(!e||!t||!t.items)return void console.warn("Cannot render cart items:",{itemsContainer:!!e,cartData:!!t,items:t?.items?.length});const n=this.#M(t);if(this.#S)return e.innerHTML="",n.forEach(t=>{const n=new CartItem(t);e.appendChild(n)}),void(this.#S=!1);const r=Array.from(e.querySelectorAll("cart-item")),i=new Set(r.map(t=>t.getAttribute("key"))),a=n.map(t=>t.key||t.id),s=new Set(a);this.#j(e,s);const o=n.filter(t=>!i.has(t.key||t.id));this.#$(e,o,a)}setCartItemTemplate(t,e){CartItem.setTemplate(t,e)}setCartItemProcessingTemplate(t){CartItem.setProcessingTemplate(t)}show(t=null,e){const n=this;n.triggerEl=t||!1,n.#x(),n.contentPanel.classList.remove("hidden"),requestAnimationFrame(()=>{n.setAttribute("aria-hidden","false"),n.triggerEl&&n.triggerEl.setAttribute("aria-expanded","true");const t=n.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');t&&requestAnimationFrame(()=>{t.focus()}),n.refreshCart(e),n.#q("cart-dialog:show",{triggerElement:n.triggerEl})})}hide(){const t=this;if(t.triggerEl)t.triggerEl.focus(),t.triggerEl.setAttribute("aria-expanded","false");else{const e=document.activeElement;e&&t.contains(e)&&e.blur()}requestAnimationFrame(()=>{t.setAttribute("aria-hidden","true"),t.#q("cart-dialog:hide",{triggerElement:t.triggerEl}),t.#L()})}}class CartOverlay extends HTMLElement{constructor(){super(),this.setAttribute("tabindex","-1"),this.setAttribute("aria-hidden","true"),this.cartDialog=this.closest("cart-dialog"),this.#g()}#g(){this.addEventListener("click",()=>{this.cartDialog.hide()})}}class CartPanel extends HTMLElement{constructor(){super(),this.setAttribute("role","document")}}customElements.get("cart-dialog")||customElements.define("cart-dialog",CartDialog),customElements.get("cart-overlay")||customElements.define("cart-overlay",CartOverlay),customElements.get("cart-panel")||customElements.define("cart-panel",CartPanel),"undefined"!=typeof window&&(window.CartItem=CartItem),t.CartDialog=CartDialog,t.CartItem=CartItem,t.CartOverlay=CartOverlay,t.CartPanel=CartPanel,t.default=CartDialog,Object.defineProperty(t,"__esModule",{value:!0})});
