!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).CartPanel={})}(this,function(t){"use strict";class EventEmitter{#t;constructor(){this.#t=new Map}on(t,e){if("function"!=typeof e)throw new TypeError("Listener must be a function");const r=this.#t.get(t)||[];return r.includes(e)||r.push(e),this.#t.set(t,r),this}off(t,e){const r=this.#t.get(t);if(!r)return this;const n=r.indexOf(e);return-1!==n&&(r.splice(n,1),0===r.length?this.#t.delete(t):this.#t.set(t,r)),this}emit(t,...e){const r=this.#t.get(t);if(!r||0===r.length)return!1;for(let n=0,a=r.length;n<a;++n)try{r[n].apply(this,e)}catch(e){console.error(`Error in listener for event '${t}':`,e)}return!0}removeAllListeners(t){return t?this.#t.delete(t):this.#t.clear(),this}}class CartItem extends HTMLElement{static#e=new Map;static#r=null;#n="ready";#a=!1;#i=!1;#s={};#o=null;#c=null;#l="";static setTemplate(t,e){if("string"!=typeof t)throw new Error("Template name must be a string");if("function"!=typeof e)throw new Error("Template must be a function");CartItem.#e.set(t,e)}static setProcessingTemplate(t){if("function"!=typeof t)throw new Error("Processing template must be a function");CartItem.#r=t}static createAnimated(t,e){return new CartItem(t,e,{animate:!0})}static get observedAttributes(){return["state","key"]}attributeChangedCallback(t,e,r){e!==r&&"state"===t&&(this.#n=r||"ready")}constructor(t=null,e=null,r={}){super(),this.#o=t,this.#c=e;const n=r.animate||this.hasAttribute("animate-in");this.#n=t&&n?"appearing":this.getAttribute("state")||"ready",this.#s={click:this.#m.bind(this),change:this.#d.bind(this),transitionEnd:this.#u.bind(this)}}connectedCallback(){const t=this;t.#o&&t.#h(),t.#p(),t.#g(),t.#y(),"appearing"===t.#n&&(t.setAttribute("state","appearing"),t.#i=!0,requestAnimationFrame(()=>{t.style.height=`${t.scrollHeight}px`,requestAnimationFrame(()=>t.setState("ready"))}))}disconnectedCallback(){this.#C()}#p(){this.content=this.querySelector("cart-item-content"),this.processing=this.querySelector("cart-item-processing")}#y(){const t=this;t.addEventListener("click",t.#s.click),t.addEventListener("change",t.#s.change),t.addEventListener("quantity-input:change",t.#s.change),t.addEventListener("transitionend",t.#s.transitionEnd)}#C(){const t=this;t.removeEventListener("click",t.#s.click),t.removeEventListener("change",t.#s.change),t.removeEventListener("quantity-input:change",t.#s.change),t.removeEventListener("transitionend",t.#s.transitionEnd)}get state(){return this.#n}get cartKey(){return this.getAttribute("key")}#m(t){t.target.closest("[data-action-remove-item]")&&(t.preventDefault(),this.#f())}#d(t){if("quantity-input:change"===t.type)return void this.#E(t.detail.value);const e=t.target.closest("[data-cart-quantity]");e&&this.#E(e.value)}#u(t){"height"===t.propertyName&&this.#a?this.remove():"height"===t.propertyName&&this.#i&&(this.style.height="",this.#i=!1)}#f(){this.dispatchEvent(new CustomEvent("cart-item:remove",{bubbles:!0,detail:{cartKey:this.cartKey,element:this}}))}#E(t){this.dispatchEvent(new CustomEvent("cart-item:quantity-change",{bubbles:!0,detail:{cartKey:this.cartKey,quantity:parseInt(t),element:this}}))}#h(){const t=this;if(!t.#o||0===CartItem.#e.size)return;const e=t.#o.key||t.#o.id;e&&t.setAttribute("key",e);const r=t.#v();t.#l=r;const n=CartItem.#r?CartItem.#r():'<div class="cart-item-loader"></div>';t.innerHTML=`\n\t\t\t<cart-item-content>\n\t\t\t\t${r}\n\t\t\t</cart-item-content>\n\t\t\t<cart-item-processing>\n\t\t\t\t${n}\n\t\t\t</cart-item-processing>\n\t\t`}setData(t,e=null){const r=this;r.#o=t,e&&(r.#c=e);if(r.#v()===r.#l)return r.setState("ready"),void r.#I();r.setState("ready"),r.#h(),r.#p(),r.#g()}#v(){if(!this.#o||0===CartItem.#e.size)return"";const t=this.#o.properties?._cart_template||"default",e=CartItem.#e.get(t)||CartItem.#e.get("default");return e?e(this.#o,this.#c):""}#I(){if(!this.#o)return;const t=this.querySelector("quantity-input");t&&(t.value=this.#o.quantity)}#g(){if(!this.#o)return;const t=this.querySelectorAll("[data-content-line-price]"),e=this.#b(this.#o.line_price||0);t.forEach(t=>{t.textContent=e})}#b(t){return"number"!=typeof t?"$0.00":`$${(t/100).toFixed(2)}`}get itemData(){return this.#o}setState(t){["ready","processing","destroying","appearing"].includes(t)&&this.setAttribute("state",t)}destroyYourself(){const t=this;if(t.#a)return;t.#a=!0;const e=t.offsetHeight;t.setState("destroying"),requestAnimationFrame(()=>{t.style.height=`${e}px`;const r=getComputedStyle(t).getPropertyValue("--cart-item-destroying-duration")?.trim()||"400ms";t.style.transition=`height ${r} ease`,t.style.height="0px",setTimeout(()=>t.remove(),600)})}}class CartItemContent extends HTMLElement{constructor(){super()}}class CartItemProcessing extends HTMLElement{constructor(){super()}}customElements.get("cart-item")||customElements.define("cart-item",CartItem),customElements.get("cart-item-content")||customElements.define("cart-item-content",CartItemContent),customElements.get("cart-item-processing")||customElements.define("cart-item-processing",CartItemProcessing),"undefined"!=typeof window&&(window.CartItem=CartItem);class CartPanel extends HTMLElement{#T=null;#D;#S=!0;constructor(){super(),this.#D=new EventEmitter}connectedCallback(){this.#y(),this.hasAttribute("manual")||this.refreshCart()}disconnectedCallback(){}on(t,e){return this.#D.on(t,e),this}off(t,e){return this.#D.off(t,e),this}show(t=null,e=null){const r=this,n=r.#q();n?(n.show(t),r.refreshCart(e),r.#L("cart-panel:show",{triggerElement:t})):console.warn("cart-panel: No dialog-panel ancestor found. Cart panel is visible but not in a modal.")}hide(){const t=this.#q();t&&(t.hide(),this.#L("cart-panel:hide",{}))}getCart(){return fetch("/cart.json",{credentials:"same-origin"}).then(t=>{if(!t.ok)throw Error(t.statusText);return t.json()}).catch(t=>(console.error("Error fetching cart:",t),{error:!0,message:t.message}))}updateCartItem(t,e){return fetch("/cart/change.json",{method:"POST",credentials:"same-origin",body:JSON.stringify({id:t,quantity:e}),headers:{"Content-Type":"application/json"}}).then(t=>{if(!t.ok)throw Error(t.statusText);return t.json()}).catch(t=>(console.error("Error updating cart item:",t),{error:!0,message:t.message}))}async refreshCart(t=null){const e=this;if(!(t=t||await e.getCart())||t.error)return console.warn("Cart data has error or is null:",t),t;e.#T=t,e.#A(t),e.#w(t);const r=e.#k(t);return e.#L("cart-panel:refreshed",{cart:r}),e.#L("cart-panel:data-changed",r),t}setCartItemTemplate(t,e){CartItem.setTemplate(t,e)}setCartItemProcessingTemplate(t){CartItem.setProcessingTemplate(t)}#q(){return this.closest("dialog-panel")}#L(t,e=null){this.#D.emit(t,e),this.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0}))}#y(){this.addEventListener("click",t=>{t.target.closest("[data-action-hide-cart]")&&this.hide()}),this.addEventListener("cart-item:remove",t=>{this.#P(t)}),this.addEventListener("cart-item:quantity-change",t=>{this.#M(t)})}#P(t){const e=this,{cartKey:r,element:n}=t.detail;n.setState("processing"),e.updateCartItem(r,0).then(t=>{if(t&&!t.error){e.#T=t,e.#A(t),e.#w(t);const r=e.#k(t);e.#L("cart-panel:updated",{cart:r}),e.#L("cart-panel:data-changed",r)}else n.setState("ready"),console.error("Failed to remove cart item:",r)}).catch(t=>{n.setState("ready"),console.error("Error removing cart item:",t)})}#M(t){const e=this,{cartKey:r,quantity:n,element:a}=t.detail;a.setState("processing"),e.updateCartItem(r,n).then(t=>{if(t&&!t.error){e.#T=t,e.#A(t),e.#w(t);const r=e.#k(t);e.#L("cart-panel:updated",{cart:r}),e.#L("cart-panel:data-changed",r)}else a.setState("ready"),console.error("Failed to update cart item quantity:",r,n)}).catch(t=>{a.setState("ready"),console.error("Error updating cart item quantity:",t)})}#_(t){if(!t)return;const e=this.#x(t).reduce((t,e)=>t+e.quantity,0);document.querySelectorAll("[data-content-cart-count]").forEach(t=>{t.textContent=e})}#H(t){if(!t)return;const e=t.items.filter(t=>{const e=t.properties?._ignore_price_in_subtotal;return!e}).reduce((t,e)=>t+(e.line_price||0),0);document.querySelectorAll("[data-content-cart-subtotal]").forEach(t=>{const r=(e/100).toFixed(2);t.textContent=`$${r}`})}#w(t=null){const e=this,r=t||e.#T;if(!r)return;const n=e.#x(r).length>0;e.setAttribute("state",n?"has-items":"empty");const a=e.querySelector("[data-cart-has-items]"),i=e.querySelector("[data-cart-is-empty]");a&&i&&(a.style.display=n?"":"none",i.style.display=n?"none":""),e.#_(r),e.#H(r)}#A(t){const e=this,r=e.querySelector("[data-content-cart-items]");if(!r||!t||!t.items)return;const n=e.#x(t);if(e.#S)return r.innerHTML="",n.forEach(e=>{r.appendChild(new CartItem(e,t))}),void(e.#S=!1);const a=Array.from(r.querySelectorAll("cart-item")),i=new Set(a.map(t=>t.getAttribute("key"))),s=n.map(t=>t.key||t.id),o=new Set(s);e.#O(r,o),e.#F(r,t);const c=n.filter(t=>!i.has(t.key||t.id));e.#$(r,c,s,t)}#O(t,e){Array.from(t.querySelectorAll("cart-item")).filter(t=>!e.has(t.getAttribute("key"))).forEach(t=>{t.destroyYourself()})}#F(t,e){const r=this.#x(e);Array.from(t.querySelectorAll("cart-item")).forEach(t=>{const n=t.getAttribute("key"),a=r.find(t=>(t.key||t.id)===n);a&&t.setData(a,e)})}#$(t,e,r,n){setTimeout(()=>{e.forEach(e=>{const a=CartItem.createAnimated(e,n),i=r.indexOf(e.key||e.id);if(0===i)t.insertBefore(a,t.firstChild);else{let e=null;for(let n=i-1;n>=0;n--){const a=r[n],i=t.querySelector(`cart-item[key="${a}"]`);if(i){e=i;break}}e?e.insertAdjacentElement("afterend",a):t.appendChild(a)}})},100)}#x(t){return t&&t.items?t.items.filter(t=>{const e=t.properties?._hide_in_cart;return!e}):[]}#k(t){if(!t)return t;const e=this.#x(t).reduce((t,e)=>t+e.quantity,0),r=t.items.filter(t=>!t.properties?._ignore_price_in_subtotal).reduce((t,e)=>t+(e.line_price||0),0);return{...t,calculated_count:e,calculated_subtotal:r}}}customElements.get("cart-panel")||customElements.define("cart-panel",CartPanel),t.CartItem=CartItem,t.CartItemContent=CartItemContent,t.CartItemProcessing=CartItemProcessing,t.CartPanel=CartPanel,t.default=CartPanel,Object.defineProperty(t,"__esModule",{value:!0})});
